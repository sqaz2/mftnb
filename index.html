<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Moving Forward to New Beginnings | Red Deer Movers</title>
  <meta name="description" content="Professional moving services in Red Deer and surrounding areas. Local & long‑distance moves, packing, loading, unloading, and more. Free estimates." />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="icon" type="image/png" href="logo.png">
  <script defer src="https://challenges.cloudflare.com/turnstile/v0/api.js"></script>
  <style>
    :root{ --brand-50:#f0e0e1; --brand-100:#e0c0c2; --brand-600:#b8373e; --brand-700:#992e34; --brand-800:#6b2024; --brand-900:#54191d; }

    .caret { width: 1px; background: currentColor; display:inline-block; animation: blink 1s step-end infinite; }
    @keyframes blink { 50% { opacity: 0; } }
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    .fade-in { animation: fade 300ms ease-out; }
    @keyframes fade { from { opacity: 0; transform: translateY(4px) } to { opacity: 1; transform:none } }
  </style>
  <!-- Schema.org for a MovingCompany -->
  <script type="application/ld+json" id="org-jsonld">
  {
    "@context": "https://schema.org",
    "@type": "MovingCompany",
    "name": "Moving Forward to New Beginnings",
    "url": "https://www.mftnb.com/",
    "email": "info@mftnb.ca",
    "telephone": "+1-587-731-0695",
    "areaServed": "Red Deer, Alberta",
    "address": {
      "@type": "PostalAddress",
      "addressLocality": "Red Deer",
      "addressRegion": "AB",
      "addressCountry": "CA"
    }
  }
  </script>
</head>
<body class="bg-zinc-50 text-zinc-900">
  <!-- Top bar -->
  <header class="bg-zinc-900 text-white">
    <div class="max-w-6xl mx-auto px-4 py-2 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="logo.png" alt="Moving Forward to New Beginnings logo" class="h-10 w-auto select-none" onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20width%3D%27200%27%20height%3D%2748%27%3E%3Ctext%20x%3D%270%27%20y%3D%2736%27%20font-family%3D%27Inter%2C%20system-ui%2C%20Arial%27%20font-size%3D%2736%27%20font-weight%3D%27700%27%20fill%3D%27%23992e34%27%3EMFTNB%3C/text%3E%3C/svg%3E';">
        <span class="font-semibold tracking-wide">Moving Forward to New Beginnings</span>
      </div>
      <nav class="hidden sm:flex items-center gap-6 text-sm">
        <a href="#services" class="hover:underline">Services</a>
        <a href="#estimator" class="hover:underline">Get Estimate</a>
        <a href="#contact" class="hover:underline">Contact</a>
      </nav>
      <div class="flex items-center gap-4">
        <a id="topPhone" href="tel:+15877310695" class="text-sm underline decoration-white/30 underline-offset-4">(587) 731‑0695</a>
        <a id="topEmail" href="mailto:info@mftnb.ca" class="hidden md:inline text-sm underline decoration-white/30 underline-offset-4">info@mftnb.ca</a>
      </div>
    </div>
  </header>

  <!-- Hero -->
  <section class="bg-gradient-to-b from-white to-zinc-100">
    <div class="max-w-6xl mx-auto px-4 py-16 grid lg:grid-cols-2 gap-8 items-center">
      <div>
        <h1 class="text-3xl sm:text-4xl md:text-5xl font-extrabold leading-tight">Reliable movers for Red Deer & surrounding areas</h1>
        <p class="mt-4 text-zinc-600 text-lg">Local and long‑distance moving, packing, loading and unloading—done with care so you can focus on your new beginning.</p>
        <div class="mt-6 flex flex-wrap gap-3">
          <a href="#estimator" class="px-5 py-3 rounded-xl bg-[var(--brand-700)] text-white font-medium hover:bg-[var(--brand-800)]">Get a Free Estimate</a>
          <a href="#services" class="px-5 py-3 rounded-xl bg-white border border-zinc-200 font-medium hover:bg-zinc-50">See Services</a>
        </div>
        <div class="mt-6 text-sm text-zinc-500">Open Mon–Fri 9–6, Sat 10–2 · Fully insured · Friendly crews</div>
      </div>
      <div class="relative">
        <div class="aspect-video w-full rounded-2xl bg-white shadow ring-1 ring-zinc-200 grid place-items-center">
          <div class="text-center p-6">
            <div class="text-xl font-semibold">Free Chat‑Style Estimate</div>
            <p class="mt-2 text-zinc-600">Walk through your home room‑by‑room, list items, and pick your move date. Save progress and submit in minutes.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Services -->
  <section id="services" class="py-14">
    <div class="max-w-6xl mx-auto px-4">
      <h2 class="text-2xl font-bold">Services</h2>
      <div class="mt-6 grid sm:grid-cols-2 lg:grid-cols-3 gap-6">
        <article class="p-5 bg-white rounded-2xl border border-zinc-200 shadow-sm">
          <h3 class="font-semibold">Residential Moving</h3>
          <p class="text-sm text-zinc-600 mt-1">Apartments, condos, houses. Careful packing, loading, transport, and setup.</p>
        </article>
        <article class="p-5 bg-white rounded-2xl border border-zinc-200 shadow-sm">
          <h3 class="font-semibold">Long‑Distance & Local</h3>
          <p class="text-sm text-zinc-600 mt-1">Whether you’re moving across town or across Alberta, we’ll get you there.</p>
        </article>
        <article class="p-5 bg-white rounded-2xl border border-zinc-200 shadow-sm">
          <h3 class="font-semibold">Packing & Supplies</h3>
          <p class="text-sm text-zinc-600 mt-1">Full or partial packing, boxes and materials available on request.</p>
        </article>
        <article class="p-5 bg-white rounded-2xl border border-zinc-200 shadow-sm">
          <h3 class="font-semibold">Loading / Unloading</h3>
          <p class="text-sm text-zinc-600 mt-1">Truck, pod, or storage—hire us to load or unload professionally.</p>
        </article>
        <article class="p-5 bg-white rounded-2xl border border-zinc-200 shadow-sm">
          <h3 class="font-semibold">Specialty Items</h3>
          <p class="text-sm text-zinc-600 mt-1">Large or fragile items (e.g., pianos, safes). We’ll plan it properly.</p>
        </article>
        <article class="p-5 bg-white rounded-2xl border border-zinc-200 shadow-sm">
          <h3 class="font-semibold">Clean‑outs & Junk Removal</h3>
          <p class="text-sm text-zinc-600 mt-1">Optional add‑on to leave your place broom‑clean.</p>
        </article>
      </div>
    </div>
  </section>

  <!-- Estimator -->
  <section id="estimator" class="py-14 bg-white">
    <div class="max-w-6xl mx-auto px-4">
      <div class="flex items-center justify-between gap-4">
        <h2 class="text-2xl font-bold">Chat‑Style Moving Estimate</h2>
        <div class="text-sm text-zinc-600">Your info is saved to this device and only submitted when you press <span class="font-medium">Send</span>.</div>
      </div>

      <!-- Stepper -->
      <ol id="stepper" class="mt-4 flex flex-wrap items-center gap-2 text-xs text-zinc-600">
        <li class="px-2 py-1 rounded bg-zinc-100" data-step="1">Contact</li>
        <li class="px-2 py-1 rounded bg-zinc-100" data-step="2">Addresses</li>
        <li class="px-2 py-1 rounded bg-zinc-100" data-step="3">Date/Time</li>
        <li class="px-2 py-1 rounded bg-zinc-100" data-step="4">Home & Access</li>
        <li class="px-2 py-1 rounded bg-zinc-100" data-step="5">Inventory</li>
        <li class="px-2 py-1 rounded bg-zinc-100" data-step="6">Extras</li>
        <li class="px-2 py-1 rounded bg-zinc-100" data-step="7">Review</li>
      </ol>

      <!-- Progress -->
      <div class="mt-2 w-full bg-zinc-100 rounded-full h-2">
        <div id="progressBar" class="h-2 bg-[var(--brand-700)] rounded-full" style="width:0%"></div>
      </div>
      <div class="mt-2 text-xs text-zinc-500"><span id="stepLabel">Step 1 of 13</span></div>

      <div class="mt-6 grid lg:grid-cols-2 gap-6">
        <!-- Chat window -->
        <div class="rounded-2xl border border-zinc-200 shadow-sm overflow-hidden bg-zinc-50">
          <div id="chat" class="h-[58dvh] md:h-[520px] overflow-y-auto p-4 space-y-3 text-sm">
            <!-- Messages injected here -->
          </div>
          <div id="composer" class="border-t border-zinc-200 bg-white p-3 pb-[max(env(safe-area-inset-bottom),0px)]">
            <div id="currentPrompt" class="text-xs text-zinc-600 mb-1 max-h-12 overflow-hidden"></div>
            <div class="flex gap-2">
              <input id="chatInput" class="flex-1 px-3 py-2 rounded-lg border border-zinc-300 focus:outline-none focus:ring-2 focus:ring-[var(--brand-700)]" placeholder="Type your answer and press Enter…" />
              <button id="chatNext" class="px-4 py-2 rounded-lg bg-[var(--brand-700)] hover:bg-[var(--brand-800)] text-white disabled:opacity-50 disabled:cursor-not-allowed"><span id="nextLabel">Start</span></button>
            </div>
          </div>
        </div>

        <!-- Summary & actions -->
        <aside class="rounded-2xl border border-zinc-200 shadow-sm bg-white p-4 space-y-4">
          <h3 class="font-semibold">Your estimate</h3>
          <div id="summaryCards" class="grid gap-3 text-sm"></div>

          <div class="flex items-start gap-2 text-sm">
            <input id="consent" type="checkbox" class="mt-1">
            <label for="consent" class="text-zinc-600">I agree to the <a href="#" id="openPolicy" class="underline">Privacy Policy</a> and allow contact about my move.</label>
          </div>

          <div class="flex flex-wrap gap-2">
            <button id="btnSend" class="px-4 py-2 rounded-lg bg-[var(--brand-700)] hover:bg-[var(--brand-800)] text-white">Send to MFTNB</button>
            <button id="btnEditInfo" class="px-4 py-2 rounded-lg border">Edit answers</button>
          </div>

          <!-- Cloudflare Turnstile (optional; safe no-keys on client). Visible compact widget to reduce spam. -->
          <div class="mt-1">
            <div class="cf-turnstile" data-sitekey="0x4AAAAAAB2gwLXxC5IfxB3W" data-theme="auto" data-size="compact"></div>
          </div>

          <details class="text-xs text-zinc-500">
            <summary class="cursor-pointer">For office use</summary>
            <div class="mt-2">
              <div class="flex gap-2 mb-2">
                <button id="btnCopy" class="px-3 py-1 rounded border text-xs">Copy JSON</button>
                <button id="btnDownload" class="px-3 py-1 rounded border text-xs">Download JSON</button>
                <button id="btnClear" class="px-3 py-1 rounded border text-xs">Clear</button>
              </div>
              <pre id="jsonSummary" class="text-[10px] bg-zinc-50 p-2 rounded-lg overflow-auto max-h-40"></pre>
            </div>
          </details>
          <p id="sendStatus" class="text-sm"></p>
          <div class="text-xs text-zinc-500">By submitting, you consent to us contacting you about your move. We never sell your info.</div>
        </aside>
      </div>
    </div>
  </section>

  <!-- Contact -->
  <section id="contact" class="py-16 bg-zinc-100">
    <div class="max-w-6xl mx-auto px-4 grid md:grid-cols-2 gap-8 items-start">
      <div>
        <h2 class="text-2xl font-bold">Contact</h2>
        <p class="mt-3 text-zinc-600">Call, email, or send the estimate—whatever’s easiest.</p>
        <ul class="mt-4 space-y-2 text-sm">
          <li><span class="font-medium">Phone:</span> <a href="tel:+15877310695" class="underline">(587) 731‑0695</a></li>
          <li><span class="font-medium">Email:</span> <a href="mailto:info@mftnb.ca" class="underline">info@mftnb.ca</a></li>
          <li><span class="font-medium">Hours:</span> Mon–Fri 9–6, Sat 10–2</li>
          <li><span class="font-medium">Area:</span> Red Deer & surrounding communities</li>
        </ul>
      </div>
      <div class="p-5 rounded-2xl bg-white border border-zinc-200 shadow-sm">
        <h3 class="font-semibold">Quick Message</h3>
        <form class="mt-3 grid gap-3" onsubmit="event.preventDefault(); window.scrollTo({top: document.getElementById('estimator').offsetTop, behavior:'smooth'});">
          <input class="px-3 py-2 rounded-lg border" placeholder="Your name" />
          <input class="px-3 py-2 rounded-lg border" placeholder="Email" />
          <textarea class="px-3 py-2 rounded-lg border" rows="3" placeholder="Message" ></textarea>
          <button class="px-4 py-2 rounded-lg bg-zinc-900 text-white">Start Estimate</button>
        </form>
      </div>
    </div>
  </section>

  <!-- Welcome Overlay -->
  <div id="welcome" class="fixed inset-0 bg-black/40 backdrop-blur-sm grid place-items-center p-4 hidden">
    <div class="bg-white rounded-2xl shadow-xl max-w-lg w-full p-6 fade-in">
      <div class="flex items-center gap-3">
        <img src="logo.png" alt="Moving Forward to New Beginnings logo" class="h-10 w-auto select-none" onerror="this.onerror=null;this.src='data:image/svg+xml;utf8,%3Csvg%20xmlns%3D%27http%3A//www.w3.org/2000/svg%27%20width%3D%27200%27%20height%3D%2748%27%3E%3Ctext%20x%3D%270%27%20y%3D%2736%27%20font-family%3D%27Inter%2C%20system-ui%2C%20Arial%27%20font-size%3D%2736%27%20font-weight%3D%27700%27%20fill%3D%27%23992e34%27%3EMFTNB%3C/text%3E%3C/svg%3E';">
        <h3 class="text-xl font-semibold">Get a fast, friendly estimate</h3>
      </div>
      <p class="mt-3 text-zinc-600">Takes about 2 minutes. No payment or login required. You can save and come back anytime.</p>
      <ul class="mt-3 text-sm text-zinc-600 list-disc ml-5">
        <li>We’ll ask for contact + addresses</li>
        <li>Room‑by‑room inventory (with easy counters)</li>
        <li>Pick your date/time window</li>
      </ul>
      <div class="mt-5 flex items-center justify-end gap-2">
        <button id="btnSkip" class="px-4 py-2 rounded-lg border">Maybe later</button>
        <button id="btnStart" class="px-4 py-2 rounded-lg bg-[var(--brand-700)] text-white hover:bg-[var(--brand-800)]">Start</button>
      </div>
    </div>
  </div>

  <!-- Privacy Policy Modal -->
  <div id="policyModal" class="fixed inset-0 bg-black/40 backdrop-blur-sm grid place-items-center p-4 hidden">
    <div class="bg-white rounded-2xl shadow-xl max-w-2xl w-full p-6 fade-in">
      <div class="flex items-start justify-between gap-3">
        <h3 class="text-xl font-semibold">Privacy Policy</h3>
        <button id="closePolicy" class="px-3 py-1 rounded-lg border">Close</button>
      </div>
      <div class="mt-3 text-sm text-zinc-700 space-y-3 max-h-[70vh] overflow-auto">
        <p><strong>What we collect:</strong> name, contact details, pickup/drop‑off addresses, desired move date/time, and your inventory list. This helps us provide an accurate estimate and schedule your move.</p>
        <p><strong>How we use it:</strong> to contact you with an estimate, coordinate your move, and improve our services. We do not sell your data.</p>
        <p><strong>Where it’s stored:</strong> securely in our internal systems (Google Workspace/Sheets) with access restricted to staff who need it.</p>
        <p><strong>How long we keep it:</strong> we retain leads for up to 12 months unless you ask us to delete them sooner.</p>
        <p><strong>Your choices:</strong> you can request access or deletion of your information by emailing <a href="mailto:info@mftnb.ca" class="underline">info@mftnb.ca</a>.</p>
        <p>This site is operated in Alberta and we follow the Alberta Personal Information Protection Act (PIPA).</p>
      </div>
    </div>
  </div>

  <!-- Mobile sticky CTA -->
  <div class="fixed bottom-0 inset-x-0 md:hidden bg-white/95 border-t backdrop-blur px-4 py-3 flex items-center justify-between gap-3 z-50">
    <span class="text-sm font-medium">Get your free estimate</span>
    <a href="#estimator" class="px-4 py-2 rounded-lg bg-[var(--brand-700)] text-white hover:bg-[var(--brand-800)]">Start</a>
  </div>

  <footer class="py-10 border-t bg-white">
    <div class="max-w-6xl mx-auto px-4 text-sm text-zinc-500 flex flex-wrap items-center justify-between gap-3">
      <div>© <span id="year"></span> Moving Forward to New Beginnings</div>
      <div><a href="#" id="openPolicyFooter" class="underline">Privacy Policy</a> · All rights reserved.</div>
    </div>
  </footer>

  <script>
  // ======== CONFIG ========
  const BACKEND = {
    mode: 'apps_script', // 'apps_script' | 'firebase' | 'emailjs' | 'none'
    appsScriptUrl: 'https://script.google.com/macros/s/AKfycbz2kTp_RynPKZptrLJrsv_DvS_-el2bzBz8Jc_QaEej2nHop5iABnMcuEa5pff2No9W8g/exec',
    firebase: { config: { apiKey: '', authDomain: '', projectId: '', appId: '' }, collection: 'moving_estimates' },
    emailjs: { serviceId: '', templateId: '', publicKey: '' }
  };

  // ======== STATE ========
  const KEY = 'mftnb_estimate_v1';
  let state = JSON.parse(localStorage.getItem(KEY) || '{}');

  const steps = [
    { id:'intro',   prompt: "Welcome! Let's get a quick estimate started. What's your full name?", field:'name', type:'text', required:true, group:1 },
    { id:'contact', prompt: "Great, what's the best email to reach you?", field:'email', type:'email', required:true, group:1 },
    { id:'phone',   prompt: "And your phone number?", field:'phone', type:'tel', required:true, group:1 },
    { id:'pickup',  prompt: 'Pickup address (include unit/floor and city):', field:'pickup', type:'textarea', required:true, group:2 },
    { id:'dropoff', prompt: 'Drop‑off address (include unit/floor and city):', field:'dropoff', type:'textarea', required:true, group:2 },
    { id:'date',    prompt: 'Desired move date:', field:'moveDate', type:'date', required:true, group:3 },
    { id:'window',  prompt: 'Preferred time window?', field:'timeWindow', type:'select', options:['Morning','Midday','Afternoon','Flexible'], group:3 },
    { id:'home',    prompt: 'Home size?', field:'homeSize', type:'select', options:['Studio','1 Bedroom','2 Bedroom','3 Bedroom','4+ Bedroom'], group:4 },
    { id:'access',  prompt: 'Any stairs, elevator, or tight access at either location?', field:'access', type:'textarea', group:4 },
    { id:'rooms',   prompt: 'List main items per room. You can add custom items later.', field:'inventory', type:'inventory', group:5 },
    { id:'extras',  prompt: 'Any extras?', field:'extras', type:'multi', options:['Packing Service','Junk Removal','Clean‑out','Piano / Specialty Item'], group:6 },
    { id:'notes',   prompt: 'Anything else we should know?', field:'notes', type:'textarea', group:6 },
    { id:'review',  prompt: 'Review your details, then check the Privacy box and press Send.', field:'review', type:'review', group:7 },
  ];
  let stepIndex = Math.min(Number(state._stepIndex || 0), steps.length - 1);

  // ======== UI HOOKS ========
  const chatEl = document.getElementById('chat');
  const inputEl = document.getElementById('chatInput');
  const nextBtn = document.getElementById('chatNext');
  const summaryCards = document.getElementById('summaryCards');
  const jsonSummary = document.getElementById('jsonSummary');
  const currentPromptEl = document.getElementById('currentPrompt');
  const nextLabelEl = document.getElementById('nextLabel');
  const composer = document.getElementById('composer');
  const editBtn = document.getElementById('btnEditInfo');
  const progressBar = document.getElementById('progressBar');
  const stepper = document.getElementById('stepper');
  const stepLabel = document.getElementById('stepLabel');
  const sendBtn = document.getElementById('btnSend');
  const copyBtn = document.getElementById('btnCopy');
  const dlBtn = document.getElementById('btnDownload');
  const clearBtn = document.getElementById('btnClear');
  const statusEl = document.getElementById('sendStatus');
  const consent = document.getElementById('consent');
  const openPolicy = document.getElementById('openPolicy');
  const openPolicyFooter = document.getElementById('openPolicyFooter');
  const policyModal = document.getElementById('policyModal');
  const closePolicy = document.getElementById('closePolicy');
  const welcome = document.getElementById('welcome');
  const btnStart = document.getElementById('btnStart');
  const btnSkip = document.getElementById('btnSkip');

  document.getElementById('year').textContent = new Date().getFullYear();

  // Disable Send until a backend is configured, so nothing breaks if you just preview
  if (BACKEND.mode === 'none' || (BACKEND.mode === 'apps_script' && /PASTE_YOUR_WEB_APP_URL/.test(BACKEND.appsScriptUrl))) {
    const btn = document.getElementById('btnSend');
    const status = document.getElementById('sendStatus');
    if (btn) { btn.disabled = true; btn.classList.add('opacity-50','cursor-not-allowed'); }
    if (status) { status.textContent = 'Setup needed: add your Google Web App URL in the code to enable sending.'; }
  }

  // ======== CHAT HELPERS ========
  function msg(role, html) {
    const wrap = document.createElement('div');
    wrap.className = role === 'agent' ? 'flex gap-3' : 'flex gap-3 justify-end';
    const bubble = document.createElement('div');
    bubble.className = 'max-w-[85%] px-3 py-2 rounded-2xl text-sm shadow border ' + (role==='agent' ? 'bg-white border-zinc-200' : 'bg-zinc-900 text-white border-transparent');
    bubble.innerHTML = html;
    wrap.appendChild(bubble);
    chatEl.appendChild(wrap);
    chatEl.scrollTop = chatEl.scrollHeight;
  }

  function setProgress() {
    const p = Math.round((stepIndex) / (steps.length - 1) * 100);
    progressBar.style.width = p + '%';
    stepLabel.textContent = `Step ${Math.min(stepIndex+1, steps.length)} of ${steps.length}`;

    // Update stepper badges
    const g = steps[stepIndex].group;
    stepper.querySelectorAll('li').forEach((el, i) => {
      const idx = i+1;
      el.className = 'px-2 py-1 rounded ' + (idx === g ? 'bg-[var(--brand-100)] text-[var(--brand-900)] font-medium' : idx < g ? 'bg-zinc-200 text-zinc-700' : 'bg-zinc-100');
    });
  }

  function save() {
    localStorage.setItem(KEY, JSON.stringify({ ...state, _stepIndex: stepIndex }));
    renderSummary();
  }

  // ======== SUMMARY CARDS ========
  function computeEstimate(s) {
    const inv = s.inventory || {};
    const weights = { 'Boxes':1,'Sofa':15,'Bed (Queen)':12,'Mattress':8,'Dresser':8,'Dining Table':12,'Chairs':3,'TV':3,'Desk':6,'Wardrobe':8,'Washer':10,'Dryer':10,'Fridge':12 };
    let units = 0;
    for (const k in inv) { const v = Number(inv[k])||0; units += (weights[k]||5) * v; }
    const crew = units < 30 ? 2 : units < 60 ? 3 : 4;
    const hours = Math.max(2, Math.round((2 + units/15) * 2) / 2);
    return { units, recommendedCrew: crew, estimatedHours: hours, note: 'Rough estimate — subject to walkthrough' };
  }

  function renderSummary() {
    const out = { ...state };
    delete out._stepIndex;
    const inv = out.inventory || {};
    const itemCount = Object.values(inv).reduce((a,b)=> a + (Number(b)||0), 0);
    const extrasChips = (out.extras||[]).map(x=>`<span class="inline-block rounded-full bg-zinc-100 border px-2 py-0.5 mr-1">${x}</span>`).join('') || '<span class="text-zinc-400">None</span>';
    const est = computeEstimate(out);

    const contactCard = `
      <div class="p-3 rounded-xl border">
        <div class="font-medium mb-1">Contact</div>
        <div>${out.name || '<span class="text-zinc-400">Your name</span>'}</div>
        <div>${out.phone || '<span class="text-zinc-400">Phone</span>'}</div>
        <div class="truncate">${out.email || '<span class="text-zinc-400">Email</span>'}</div>
      </div>`;

    const moveCard = `
      <div class="p-3 rounded-xl border">
        <div class="font-medium mb-1">Move details</div>
        <div><span class="text-zinc-500">Date:</span> ${out.moveDate || '—'} ${out.timeWindow ? '('+out.timeWindow+')' : ''}</div>
        <div class="mt-1"><span class="text-zinc-500">Pickup:</span> ${out.pickup || '—'}</div>
        <div class="mt-1"><span class="text-zinc-500">Drop‑off:</span> ${out.dropoff || '—'}</div>
      </div>`;

    const invCard = `
      <div class="p-3 rounded-xl border">
        <div class="font-medium mb-1">Inventory</div>
        <div>${itemCount} items listed</div>
        <div class="mt-1">${extrasChips}</div>
      </div>`;

    const estCard = `
      <div class="p-3 rounded-xl border bg-[var(--brand-50)]">
        <div class="font-medium mb-1">Rough estimate</div>
        <div>Recommended crew: <span class="font-medium">${est.recommendedCrew}</span></div>
        <div>Estimated hours: <span class="font-medium">${est.estimatedHours}</span></div>
        <div class="text-xs text-zinc-600 mt-1">${est.note}</div>
      </div>`;

    summaryCards.innerHTML = contactCard + moveCard + invCard + estCard;
    jsonSummary.textContent = JSON.stringify(out, null, 2);
  }

  // ======== CHAT FLOW ========
  function askCurrent() {
    const s = steps[stepIndex];
    setProgress();
    if (!s) return;

    currentPromptEl.textContent = s.prompt;

    // Special UIs
    if (s.type === 'inventory') {
      msg('agent', `<div class="font-medium">${s.prompt}</div><div class="mt-1 text-zinc-600">Start with preset items, then add more.</div>`);
      renderInventoryUI();
      inputEl.value = state[s.field] || '';
      inputEl.placeholder = 'Add a custom item (e.g., "Bookshelf x1") and press Enter';
      updateNextState();
      return;
    }
    if (s.type === 'multi') {
      msg('agent', `<div class="font-medium">${s.prompt}</div>`);
      const opts = s.options.map(o => `<label class='inline-flex items-center gap-2 mr-2 mt-2'><input type='checkbox' value='${o}' class='extrasOpt'> <span>${o}</span></label>`).join('');
      msg('agent', `<div class='p-2'>${opts}</div>`);
      inputEl.value = '';
      inputEl.placeholder = 'Select options, add notes if needed';
      updateNextState();
      return;
    }
    if (s.type === 'review') {
      msg('agent', `<div class='font-medium'>${s.prompt}</div>`);
      inputEl.value = '';
      inputEl.placeholder = 'Review on the right, then press Send';
      updateNextState();
      return;
    }

    // Default prompt
    msg('agent', `<div class="font-medium">${s.prompt}</div>`);
    inputEl.type = (s.type === 'textarea' ? 'text' : s.type);
    inputEl.value = state[s.field] || '';
    inputEl.placeholder = '';
    updateNextState();
  }

  function saveAnswerFromInput() {
    const s = steps[stepIndex];
    if (!s) return true;

    if (s.type === 'inventory') return true;
    if (s.type === 'multi') {
      const values = Array.from(document.querySelectorAll('.extrasOpt:checked')).map(el => el.value);
      state[s.field] = values;
      save();
      return true;
    }
    if (s.type === 'review') return true;

    const val = inputEl.value.trim();
    if (s.required && !val) return false;

    if (s.type === 'email') {
      const ok = /.+@.+\..+/.test(val);
      if (!ok) { alert('Please enter a valid email.'); return false; }
    }
    if (s.field === 'phone' && val) {
      const digits = val.replace(/\D/g, '');
      if (digits.length < 10) { alert('Please enter a valid phone number.'); return false; }
    }

    state[s.field] = val;
    msg('user', val ? val.replace(/</g,'&lt;') : '<span class="text-zinc-400">(skipped)</span>');
    save();
    return true;
  }

  function next() {
    if (!saveAnswerFromInput()) return;
    stepIndex = Math.min(stepIndex + 1, steps.length - 1);
    save();
    askCurrent();
  }

  inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); next(); } });
  inputEl.addEventListener('input', updateNextState);
  inputEl.addEventListener('focus', () => { setTimeout(() => { composer.scrollIntoView({ block: 'end', behavior: 'smooth' }); }, 80); });
  nextBtn.addEventListener('click', next);
  if (editBtn) editBtn.onclick = () => { document.getElementById('estimator').scrollIntoView({behavior:'smooth'}); setTimeout(() => composer.scrollIntoView({block:'end'}), 250); };

  // Inventory UI renderer
  function renderInventoryUI() {
    const wrap = document.createElement('div');
    wrap.className = 'bg-white border border-zinc-200 rounded-xl p-3';
    wrap.innerHTML = `
      <div class='grid grid-cols-2 sm:grid-cols-3 gap-2' id='invGrid'></div>
      <div class='mt-3 flex gap-2'>
        <input id='invCustom' class='flex-1 px-3 py-2 rounded-lg border' placeholder='Custom item (e.g., "Bookshelf")'>
        <button id='addCustom' class='px-3 py-2 rounded-lg border'>Add</button>
      </div>
    `;
    chatEl.appendChild(wrap);

    const presets = [
      ['Boxes', 10], ['Sofa', 1], ['Bed (Queen)', 1], ['Mattress', 1], ['Dresser', 1],
      ['Dining Table', 1], ['Chairs', 4], ['TV', 1], ['Desk', 1], ['Wardrobe', 0],
      ['Washer', 0], ['Dryer', 0], ['Fridge', 0]
    ];

    if (!state.inventory) state.inventory = {};

    const grid = wrap.querySelector('#invGrid');
    function card(name) {
      const count = state.inventory[name] || 0;
      const div = document.createElement('div');
      div.className = 'border rounded-lg p-2 text-sm flex items-center justify-between';
      div.innerHTML = `
        <span>${name}</span>
        <div class='flex items-center gap-2'>
          <button class='px-2 py-1 rounded border' data-act='dec'>−</button>
          <input class='w-14 text-center border rounded px-2 py-1' type='number' min='0' value='${count}'/>
          <button class='px-2 py-1 rounded border' data-act='inc'>+</button>
        </div>
      `;
      div.querySelector('[data-act=inc]').onclick = () => { state.inventory[name] = (state.inventory[name]||0) + 1; div.querySelector('input').value = state.inventory[name]; save(); };
      div.querySelector('[data-act=dec]').onclick = () => { state.inventory[name] = Math.max(0,(state.inventory[name]||0) - 1); div.querySelector('input').value = state.inventory[name]; save(); };
      div.querySelector('input').onchange = (e) => { state.inventory[name] = Math.max(0, Number(e.target.value)||0); save(); };
      grid.appendChild(div);
    }

    presets.forEach(([n,_]) => card(n));

    wrap.querySelector('#addCustom').onclick = () => {
      const n = wrap.querySelector('#invCustom').value.trim();
      if (!n) return;
      if (!state.inventory[n]) state.inventory[n] = 1; else state.inventory[n] += 1;
      wrap.querySelector('#invCustom').value = '';
      card(n);
      save();
    };
  }

  // ======== BACKEND SEND ========
  function getTurnstileToken() {
    // Cloudflare Turnstile writes to a hidden input name="cf-turnstile-response"
    return document.querySelector('input[name="cf-turnstile-response"]')?.value || '';
  }

  function buildPayload() {
    const payload = { ...state, submittedAt: new Date().toISOString(), source: 'mftnb-site', turnstileToken: getTurnstileToken() };
    delete payload._stepIndex;
    return payload;
  }

  async function sendSubmission() {
    if (!consent.checked) { alert('Please agree to the Privacy Policy first.'); return; }

    statusEl.textContent = 'Sending…';
    const data = buildPayload();

    try {
      if (BACKEND.mode === 'apps_script') {
        const res = await fetch(BACKEND.appsScriptUrl, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data) });
        if (!res.ok) throw new Error('Endpoint error');
        const json = await res.json().catch(()=>({ok:true}));
        statusEl.textContent = 'Sent! We\'ll be in touch shortly.';
        return json;
      }

      if (BACKEND.mode === 'firebase') {
        if (!window.firebase) throw new Error('Firebase SDK not loaded.');
        const app = firebase.initializeApp(BACKEND.firebase.config);
        const db = firebase.firestore();
        const out = await db.collection(BACKEND.firebase.collection).add(data);
        statusEl.textContent = 'Saved to our system! We\'ll contact you soon.';
        return { id: out.id };
      }

      if (BACKEND.mode === 'emailjs') {
        if (!window.emailjs) throw new Error('EmailJS SDK not loaded.');
        await emailjs.send(BACKEND.emailjs.serviceId, BACKEND.emailjs.templateId, data, BACKEND.emailjs.publicKey);
        statusEl.textContent = 'Sent via email. We\'ll contact you soon.';
        return { ok: true };
      }

      statusEl.textContent = 'No backend configured. Use Copy/Download as fallback.';
      return { ok: false };
    } catch (e) {
      console.error(e);
      statusEl.textContent = 'Could not send. Please try again or email us directly.';
      return { ok: false, error: String(e) };
    }
  }

  // Buttons
  sendBtn.onclick = sendSubmission;
  copyBtn.onclick = () => { navigator.clipboard.writeText(JSON.stringify(buildPayload(), null, 2)); statusEl.textContent = 'Copied to clipboard'; };
  dlBtn.onclick = () => {
    const blob = new Blob([JSON.stringify(buildPayload(), null, 2)], { type:'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob); a.download = 'mftnb-estimate.json'; a.click();
  };
  if (clearBtn) clearBtn.onclick = () => { if (confirm('Clear your saved estimate?')) { localStorage.removeItem(KEY); state = {}; stepIndex = 0; chatEl.innerHTML=''; jsonSummary.textContent=''; summaryCards.innerHTML=''; askCurrent(); setProgress(); } };

  // Privacy modal
  function togglePolicy(open) { policyModal.classList[open ? 'remove' : 'add']('hidden'); }
  if (openPolicy) openPolicy.onclick = (e)=>{ e.preventDefault(); togglePolicy(true); };
  if (openPolicyFooter) openPolicyFooter.onclick = (e)=>{ e.preventDefault(); togglePolicy(true); };
  if (closePolicy) closePolicy.onclick = ()=> togglePolicy(false);

  function updateNextState() {
    const s = steps[stepIndex];
    if (!s) return;
    const requiredEmpty = !!(s.required && !inputEl.value.trim() && s.type !== 'multi' && s.type !== 'inventory' && s.type !== 'review');
    nextLabelEl.textContent = (stepIndex === 0 && requiredEmpty) ? 'Start' : 'Next';
    nextBtn.disabled = requiredEmpty;
  }

  // Welcome overlay
  function maybeShowWelcome() {
    const isFresh = !localStorage.getItem(KEY) || Object.keys(state).length === 0;
    if (isFresh) {
      welcome.classList.remove('hidden');
      nextBtn.disabled = true;
      nextLabelEl.textContent = 'Start';
    } else {
      if (!chatEl.children.length) askCurrent();
    }
  }
  if (btnStart) btnStart.onclick = () => { welcome.classList.add('hidden'); if (!chatEl.children.length) askCurrent(); setTimeout(()=>composer.scrollIntoView({block:'end', behavior:'smooth'}), 150); };
  if (btnSkip) btnSkip.onclick = () => { welcome.classList.add('hidden'); document.getElementById('services').scrollIntoView({behavior:'smooth'}); };

  // ======== INIT ========
  renderSummary();
  setProgress();
  maybeShowWelcome();
  if (!welcome || welcome.classList.contains('hidden')) { if (!chatEl.children.length) askCurrent(); }
  </script>
</body>
</html>
